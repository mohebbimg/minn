import sys
import os

# Add the project root directory to sys.path
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from src.DP_duplex_structure_prediction import run_DP_alg_on_a_set
from src.MINN_main_algorithm import train_and_test, load_and_predict


def run_on_pairs_of_seqs(microRNA_seq, cts_seq):
    tmp_fname = "temp_rundata.csv"
    with open(tmp_fname, 'w') as output_file:
        output_file.write(f"microRNA_5p3p,target_site_5p3p,label\n")
        output_file.write(f"{microRNA_seq},{cts_seq},{-1}\n")

    # predict secondary structure of input pair, with our DP algorithm:
    tmp_sec_struct_fname = run_DP_alg_on_a_set.pred_structures(tmp_fname)

    model_fullpath = os.path.join(os.path.dirname(os.path.abspath(__file__)), "../model_of_MINN.keras")

    predictions, _ = load_and_predict(model_fullpath, tmp_sec_struct_fname, True)

    # delete temp files:
    os.remove(tmp_fname)
    os.remove(tmp_sec_struct_fname)


    return predictions[0][0]


def extract_second_line(file_path):
    try:
        with open(file_path, 'r') as file:
            lines = file.readlines()
            if len(lines) >= 2:
                return lines[1].strip()  # Return the second line without leading/trailing whitespace
            else:
                return "The file has less than two lines."
    except FileNotFoundError:
        return "The specified file was not found."
    except Exception as e:
        return f"An error occurred: {e}"


def main():
    if len(sys.argv) < 2:
        print("Usage: python use_trained_MINN_to_find_target_site_on_3pUTR.py <microRNA seq> <3'UTR file> <Threshold>")
        return

    microRNA_seq = sys.argv[1]
    UTR_file = sys.argv[2]
    threshold = float(sys.argv[3])

    seq_3pUTR = extract_second_line(UTR_file).replace('T', 'U')
    for i in range(len(seq_3pUTR) - 25):
        cts_seq = seq_3pUTR[i: i+25]
        pred = run_on_pairs_of_seqs(microRNA_seq, cts_seq)
        if pred >= threshold:
            print(f"Found a Target Site: {cts_seq}")
            print(f"Target Site Prediction score: {pred}")


if __name__ == "__main__":
    main()
